<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Dumb Draw â€” Shape Rush</title>
<style>
  :root{
    --bg:#f7fbff;
    --card:#ffffff;
    --ink:#0b1630;
    --muted:#5b6b8b;
    --accent:#08b3a6;
    --accent2:#ff7ac3;
    --good:#16a34a;
    --warn:#d97706;
    --bad:#ef4444;
    --sky1:#e8f5ff; --sky2:#c9efff; --sky3:#fffcee;
  }
  html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--sky1),var(--sky2) 50%,var(--sky3));color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
  .wrap{max-width:560px;margin:0 auto;padding:14px 14px 28px;}
  h1{font-size:22px;margin:8px 0 10px;text-align:center;font-weight:900;letter-spacing:.2px}
  .hud{display:flex;justify-content:space-between;align-items:center;gap:10px;background:var(--card);border:1px solid #e6eef9;border-radius:16px;padding:10px 12px;box-shadow:0 4px 14px rgba(0,0,0,.05)}
  .hud small{color:var(--muted);display:block}
  .score{font-weight:800}
  .preview{position:relative;width:72px;height:72px;border-radius:12px;background:#f2fbff;border:1px solid #e6eef9;display:grid;place-items:center}
  .preview canvas{width:60px;height:60px}
  .board{margin-top:12px;background:#f2fbff;border:1px solid #e6eef9;border-radius:20px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  #draw{width:100%;touch-action:none;display:block;background:
    radial-gradient(800px 400px at 50% -20%, #ffffff 0%, #f2fbff 65%),
    linear-gradient(180deg, #e8f5ff 0%, #eaf8ff 60%, #fff 100%)}
  .btns{display:flex;gap:8px;margin-top:10px}
  button{flex:1;background:#fff;color:var(--ink);border:1px solid #e1e9f6;border-radius:12px;padding:10px;font-weight:700}
  button:active{transform:translateY(1px)}
  .btn-accent{background:var(--accent);color:white;border-color:var(--accent)}
  .btn-outline{background:#fff;color:var(--accent);border-color:var(--accent)}
  .toast{text-align:center;margin-top:8px;color:var(--muted);min-height:18px}
  .finalCenter{
    position:fixed;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.25);backdrop-filter:saturate(120%) blur(2px);z-index:20;
  }
  .finalCard{
    width:min(92vw,520px);background:var(--card);border:1px solid #e6eef9;border-radius:20px;
    padding:18px;box-shadow:0 10px 28px rgba(0,0,0,.18);text-align:center;
  }
  .finalTitle{font-size:30px;font-weight:900;margin:4px 0 6px}
  .finalScore{font-size:22px;font-weight:800;margin:6px 0}
  .rank{font-size:18px;font-weight:800;margin:2px 0 10px}
  .finalBtns{display:flex;gap:10px;margin-top:10px}
  .legend{font-size:12px;color:var(--muted);text-align:center;margin-top:6px}

  /* Start Modal */
  .startOverlay{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(240,252,255,.9));
    z-index:30;
  }
  .startCard{
    width:min(92vw,520px);background:var(--card);border:1px solid #e6eef9;border-radius:24px;
    padding:20px;box-shadow:0 10px 28px rgba(0,0,0,.15);text-align:center;
  }
  .startTitle{font-size:28px;font-weight:900;margin:6px 0 4px}
  .worm{font-size:42px;filter:drop-shadow(0 2px 0 rgba(0,0,0,.08))}
  .best{font-size:14px;color:var(--muted);margin-top:4px}
  .howto{font-size:14px;color:#2b3b5b;margin:10px auto 0;line-height:1.5;background:#f7fdff;border:1px dashed #cfe8ff;border-radius:12px;padding:10px;max-width:440px}
  .timerTag{font-weight:800;color:#ff3d8b}
  .playRow{display:flex;gap:10px;margin-top:12px;justify-content:center}
  .pill{display:inline-block;padding:8px 14px;border-radius:999px;background:#fff;border:1px solid #e1e9f6;font-weight:800}
  .pill.accent{background:var(--accent);color:#fff;border-color:var(--accent)}
  .pill.ghost{background:#fff;color:var(--accent);border-color:var(--accent)}

  /* HUD timer pill */
  .timePill{display:inline-block;padding:4px 10px;border-radius:999px;background:#fff3c4;border:1px solid #ffe08b;font-weight:800;color:#a16207}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸŽ¨ Dumb Draw â€” Shape Rush</h1>

    <div class="hud">
      <div>
        <div><small>Round</small><span id="round">â€“</span></div>
        <div class="score"><small>Last Score</small><span id="lastScore">â€“</span></div>
      </div>
      <div>
        <div><small>Total</small><span id="totalScore">0</span></div>
        <div><small>Shape</small><span id="shapeName">â€“</span></div>
      </div>
      <div>
        <div><small>Time</small> <span class="timePill" id="timePill">10s</span></div>
        <div class="preview"><canvas id="preview"></canvas></div>
      </div>
    </div>

    <div class="board">
      <canvas id="draw"></canvas>
    </div>

    <div class="btns">
      <button id="clearBtn">Clear</button>
      <button id="skipBtn">Skip</button>
      <button id="restartBtn" style="display:none;">Restart</button>
      <button id="shareBtn" disabled>Share on WhatsApp</button>
    </div>
    <div class="toast" id="toast">Draw the shape shown, lift to submit. You have <b>10 seconds</b> per shape!</div>
  </div>

  <!-- Final centered overlay -->
  <div class="finalCenter" id="finalOverlay">
    <div class="finalCard">
      <div class="finalTitle">ðŸŽ‰ Game Over!</div>
      <div class="finalScore" id="finalScore">Total: 0</div>
      <div class="rank" id="finalRank">Rank: Worm Doodler ðŸª±</div>
      <div class="best" id="bestLine">Best: 0</div>
      <div class="finalBtns">
        <button id="finalShare" class="btn-accent" style="flex:1">Share on WhatsApp</button>
        <button id="finalRestart" class="btn-outline" style="flex:1">Restart</button>
      </div>
      <div class="legend">Tip: faster lines, cleaner loops = higher points!</div>
    </div>
  </div>

  <!-- Start overlay -->
  <div class="startOverlay" id="startOverlay">
    <div class="startCard">
      <div class="worm">ðŸª±</div>
      <div class="startTitle">Dumb Draw â€” Shape Rush</div>
      <div class="best" id="bestAtStart">Best: 0</div>
      <div class="howto">
        Draw the tiny <b>target shape</b> (top-right) on the board.<br/>
        <span class="timerTag">You have 10 seconds per shape.</span> Score is based on how closely your line matches!
      </div>
      <div class="playRow">
        <button id="playBtn" class="pill accent">â–¶ Play</button>
        <span class="pill">5 shapes</span>
        <span class="pill ghost">Tap / Drag & Release</span>
      </div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  // ===== DOM refs =====
  var canvas = document.getElementById('draw');
  var ctx = canvas.getContext('2d');
  var prevCanvas = document.getElementById('preview');
  var pctx = prevCanvas.getContext('2d');

  var roundEl = document.getElementById('round');
  var lastScoreEl = document.getElementById('lastScore');
  var totalScoreEl = document.getElementById('totalScore');
  var shapeNameEl = document.getElementById('shapeName');
  var toast = document.getElementById('toast');
  var timePill = document.getElementById('timePill');

  var clearBtn = document.getElementById('clearBtn');
  var skipBtn = document.getElementById('skipBtn');
  var restartBtn = document.getElementById('restartBtn');
  var shareBtn = document.getElementById('shareBtn');

  var finalOverlay = document.getElementById('finalOverlay');
  var finalScore = document.getElementById('finalScore');
  var finalRank = document.getElementById('finalRank');
  var bestLine = document.getElementById('bestLine');
  var finalShare = document.getElementById('finalShare');
  var finalRestart = document.getElementById('finalRestart');

  var startOverlay = document.getElementById('startOverlay');
  var playBtn = document.getElementById('playBtn');
  var bestAtStart = document.getElementById('bestAtStart');

  // Board box (filled during resize)
  var boardBox = {minX:0,minY:0,maxX:0,maxY:0,w:0,h:0};

  // ===== Utils =====
  function lerp(a,b,t){ return a + (b-a)*t; }
  function dist(a,b){ var dx=a.x-b.x, dy=a.y-b.y; return Math.sqrt(dx*dx + dy*dy); }
  function clamp(v,lo,hi){ return Math.max(lo, Math.min(hi, v)); }
  function polylineLength(pts){ var s=0; for(var i=1;i<pts.length;i++) s+=dist(pts[i-1], pts[i]); return s; }
  function resample(pts, n){
    if(!n) n=200;
    if(pts.length<2) return pts.slice();
    var L=polylineLength(pts); if(!L) return pts.slice();
    var step=L/(n-1), d=0, i=1, out=[pts[0]];
    while(out.length<n && i<pts.length){
      var a=pts[i-1], b=pts[i];
      var seg=dist(a,b);
      if((d+seg)>=step){
        var t=(step-d)/seg;
        var np={x: lerp(a.x,b.x,t), y: lerp(a.y,b.y,t)};
        out.push(np);
        pts.splice(i,0,np);
        d=0; i++;
      } else { d+=seg; i++; }
    }
    if(out.length<n) out.push(pts[pts.length-1]);
    return out;
  }
  function bbox(pts){
    var minX=1e9,minY=1e9,maxX=-1e9,maxY=-1e9;
    for(var i=0;i<pts.length;i++){
      var p=pts[i];
      if(p.x<minX)minX=p.x; if(p.y<minY)minY=p.y;
      if(p.x>maxX)maxX=p.x; if(p.y>maxY)maxY=p.y;
    }
    return {minX:minX, minY:minY, maxX:maxX, maxY:maxY, w:maxX-minX, h:maxY-minY};
  }
  function normalizeToBox(pts, targetBox, pad){
    if(!pad) pad=0;
    if(!pts.length) return [];
    var b=bbox(pts);
    var sx=(targetBox.w-2*pad)/(b.w||1);
    var sy=(targetBox.h-2*pad)/(b.h||1);
    var s=Math.min(sx,sy);
    var cx=(targetBox.minX+targetBox.maxX)/2;
    var cy=(targetBox.minY+targetBox.maxY)/2;
    var bx=(b.minX+b.maxX)/2, by=(b.minY+b.maxY)/2;
    var out=new Array(pts.length);
    for(var i=0;i<pts.length;i++){
      var p=pts[i];
      out[i]={ x:(p.x-bx)*s + cx, y:(p.y-by)*s + cy };
    }
    return out;
  }
  function nearestAvgDistance(A,B){
    if(!A.length||!B.length) return 1e9;
    var sum=0;
    for(var i=0;i<A.length;i++){
      var a=A[i], best=1e9;
      for(var j=0;j<B.length;j+=3){
        var dx=a.x-B[j].x, dy=a.y-B[j].y;
        var d=dx*dx+dy*dy;
        if(d<best) best=d;
      }
      sum += Math.sqrt(best);
    }
    return sum/A.length;
  }

  // ===== Shapes (normalized 0..1) =====
  function shapeCircle(t){ var a=2*Math.PI*t; return {x:0.5+0.42*Math.cos(a), y:0.5+0.42*Math.sin(a)}; }
  function shapeSquare(t){
    var p=t*4;
    if (p<1) return {x: lerp(0.08,0.92,p), y:0.08};
    if (p<2) return {x:0.92, y: lerp(0.08,0.92,p-1)};
    if (p<3) return {x: lerp(0.92,0.08,p-2), y:0.92};
    return {x:0.08, y: lerp(0.92,0.08,p-3)};
  }
  function shapeTriangle(t){
    var A={x:0.5,y:0.08}, B={x:0.92,y:0.9}, C={x:0.08,y:0.9};
    var perAB=0.34, perBC=0.33, u;
    if (t<perAB){ u=t/perAB; return {x: lerp(A.x,B.x,u), y: lerp(A.y,B.y,u)}; }
    if (t<perAB+perBC){ u=(t-perAB)/perBC; return {x: lerp(B.x,C.x,u), y: lerp(B.y,C.y,u)}; }
    u=(t-perAB-perBC)/(1-perAB-perBC); return {x: lerp(C.x,A.x,u), y: lerp(C.y,A.y,u)};
  }
  function shapeStar(t){
    var R=0.42, r=R*0.4, cx=0.5, cy=0.5;
    var i=Math.floor(t*10), frac=(t*10 - i);
    var a0=(i)*Math.PI/5 - Math.PI/2, a1=(i+1)*Math.PI/5 - Math.PI/2;
    var rad0=(i%2===0? R: r), rad1=((i+1)%2===0? R: r);
    return { x: cx + (rad0*Math.cos(a0) + (rad1*Math.cos(a1)-rad0*Math.cos(a0))*frac),
             y: cy + (rad0*Math.sin(a0) + (rad1*Math.sin(a1)-rad0*Math.sin(a0))*frac) };
  }
  function shapeHeart(t){
    var a=2*Math.PI*t;
    var x=0.5 + 0.36*Math.pow(Math.sin(a),3);
    var y=0.5 - 0.26*( 13*Math.cos(a)-5*Math.cos(2*a)-2*Math.cos(3*a)-Math.cos(4*a) )/13;
    return {x:x,y:y};
  }

  var SHAPES = [
    {name:"Circle", gen:shapeCircle},
    {name:"Square", gen:shapeSquare},
    {name:"Triangle", gen:shapeTriangle},
    {name:"Star", gen:shapeStar},
    {name:"Heart", gen:shapeHeart}
  ];

  // ===== HiDPI sizing =====
  function fitHiDPICanvas(c, ctx) {
    var dpr = window.devicePixelRatio || 1;
    var cssW = Math.max(1, Math.floor(c.clientWidth));
    var cssH = Math.max(1, Math.floor(c.clientHeight));
    c.width  = Math.round(cssW * dpr);
    c.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // draw in CSS pixels
    ctx.imageSmoothingEnabled = true;
    return { cssW:cssW, cssH:cssH, dpr:dpr };
  }

  function resizeAll() {
    var board = document.querySelector('.board');
    var cssSize = Math.floor(board.clientWidth);
    canvas.style.width = cssSize + 'px';
    canvas.style.height = cssSize + 'px';

    var prevSize = 60;
    prevCanvas.style.width = prevSize + 'px';
    prevCanvas.style.height = prevSize + 'px';

    fitHiDPICanvas(canvas, ctx);
    fitHiDPICanvas(prevCanvas, pctx);

    var PAD = 24;
    boardBox.minX = PAD;
    boardBox.minY = PAD;
    boardBox.maxX = canvas.clientWidth - PAD;
    boardBox.maxY = canvas.clientHeight - PAD;
    boardBox.w = boardBox.maxX - boardBox.minX;
    boardBox.h = boardBox.maxY - boardBox.minY;

    if (order && order.length) {
      clearCanvas();
      renderTargetPreview();
    }
  }

  window.addEventListener('resize', resizeAll);
  window.addEventListener('orientationchange', resizeAll);

  // ===== Drawing / input =====
  function getPos(e){
    var rect = canvas.getBoundingClientRect();
    var x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    var y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    return { x:x, y:y };
  }

  var rounds = 5, order = [], idx = 0, total = 0;
  var drawing = false, stroke = [];
  var roundTime = 10; // seconds
  var timeLeft = roundTime;
  var timerId
