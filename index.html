<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Dumb Draw — Shape Rush</title>
<style>
  :root { --bg:#0f172a; --card:#131c31; --ink:#e2e8f0; --muted:#94a3b8; --accent:#22d3ee; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
  html,body { margin:0; height:100%; background:linear-gradient(180deg,#0b1224,#0f172a); color:var(--ink); font-family:system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; }
  .wrap { max-width:520px; margin:0 auto; padding:12px 12px 24px; }
  h1 { font-size:20px; margin:10px 0 8px; text-align:center; }
  .hud { display:flex; justify-content:space-between; align-items:center; gap:10px; background:var(--card); border:1px solid #1f2a44; border-radius:14px; padding:10px 12px; }
  .hud small{ color:var(--muted); display:block; }
  .score { font-weight:700; }
  .preview { position:relative; width:68px; height:68px; border-radius:10px; background:#0b1326; border:1px solid #1f2a44; display:grid; place-items:center; }
  .preview canvas { width:56px; height:56px; }
  .board { margin-top:12px; background:#0b1326; border:1px solid #1f2a44; border-radius:18px; overflow:hidden; }
  #draw { width:100%; touch-action:none; display:block; background:radial-gradient(1200px 500px at 50% -120%, #1a2a54 0%, #0b1326 60%); }
  .btns { display:flex; gap:8px; margin-top:10px; }
  button { flex:1; background:#0f1a33; color:var(--ink); border:1px solid #1f2a44; border-radius:12px; padding:10px; font-weight:600; }
  button:active { transform:translateY(1px); }
  .toast { text-align:center; margin-top:8px; color:var(--muted); min-height:18px; }
  .final { text-align:center; padding:18px; border:1px dashed #26365f; border-radius:14px; margin-top:12px; display:none; }
  .rank { font-size:20px; font-weight:800; margin-top:6px; }
  .legend { font-size:12px; color:var(--muted); text-align:center; margin-top:6px; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>🌀 Dumb Draw — Shape Rush</h1>
    <div class="hud">
      <div>
        <div><small>Round</small><span id="round">1 / 5</span></div>
        <div class="score"><small>Last Score</small><span id="lastScore">–</span></div>
      </div>
      <div>
        <div><small>Total</small><span id="totalScore">0</span></div>
        <div><small>Shape</small><span id="shapeName">Circle</span></div>
      </div>
      <div class="preview"><canvas id="preview"></canvas></div>
    </div>

    <div class="board">
      <canvas id="draw"></canvas>
    </div>

    <div class="btns">
      <button id="clearBtn">Clear</button>
      <button id="skipBtn">Skip</button>
      <button id="restartBtn" style="display:none;">Restart</button>
    </div>
    <div class="toast" id="toast">Draw the shape and lift to submit.</div>

    <div class="final" id="finalBox">
      <div style="font-size:28px;font-weight:900" id="finalScore">Total: 0</div>
      <div class="rank" id="finalRank">Rank: Worm Doodler 🪱</div>
      <div class="legend">Tap <b>Restart</b> to play another 5 random shapes.</div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  // ===== DOM refs first =====
  var canvas = document.getElementById('draw');
  var ctx = canvas.getContext('2d');
  var prevCanvas = document.getElementById('preview');
  var pctx = prevCanvas.getContext('2d');

  var roundEl = document.getElementById('round');
  var lastScoreEl = document.getElementById('lastScore');
  var totalScoreEl = document.getElementById('totalScore');
  var shapeNameEl = document.getElementById('shapeName');
  var toast = document.getElementById('toast');
  var finalBox = document.getElementById('finalBox');
  var finalScore = document.getElementById('finalScore');
  var finalRank = document.getElementById('finalRank');
  var clearBtn = document.getElementById('clearBtn');
  var skipBtn = document.getElementById('skipBtn');
  var restartBtn = document.getElementById('restartBtn');

  // Board box (filled during resize)
  var boardBox = {minX:0,minY:0,maxX:0,maxY:0,w:0,h:0};

  // ===== Utils =====
  function lerp(a,b,t){ return a + (b-a)*t; }
  function dist(a,b){ var dx=a.x-b.x, dy=a.y-b.y; return Math.sqrt(dx*dx + dy*dy); }
  function clamp(v,lo,hi){ return Math.max(lo, Math.min(hi, v)); }
  function polylineLength(pts){ var s=0; for(var i=1;i<pts.length;i++) s+=dist(pts[i-1], pts[i]); return s; }
  function resample(pts, n){
    if(!n) n=200;
    if(pts.length<2) return pts.slice();
    var L=polylineLength(pts); if(!L) return pts.slice();
    var step=L/(n-1), d=0, i=1, out=[pts[0]];
    while(out.length<n && i<pts.length){
      var a=pts[i-1], b=pts[i];
      var seg=dist(a,b);
      if((d+seg)>=step){
        var t=(step-d)/seg;
        var np={x: lerp(a.x,b.x,t), y: lerp(a.y,b.y,t)};
        out.push(np);
        pts.splice(i,0,np);
        d=0; i++;
      } else { d+=seg; i++; }
    }
    if(out.length<n) out.push(pts[pts.length-1]);
    return out;
  }
  function bbox(pts){
    var minX=1e9,minY=1e9,maxX=-1e9,maxY=-1e9;
    for(var i=0;i<pts.length;i++){
      var p=pts[i];
      if(p.x<minX)minX=p.x; if(p.y<minY)minY=p.y;
      if(p.x>maxX)maxX=p.x; if(p.y>maxY)maxY=p.y;
    }
    return {minX:minX, minY:minY, maxX:maxX, maxY:maxY, w:maxX-minX, h:maxY-minY};
  }
  function normalizeToBox(pts, targetBox, pad){
    if(!pad) pad=0;
    if(!pts.length) return [];
    var b=bbox(pts);
    var sx=(targetBox.w-2*pad)/(b.w||1);
    var sy=(targetBox.h-2*pad)/(b.h||1);
    var s=Math.min(sx,sy);
    var cx=(targetBox.minX+targetBox.maxX)/2;
    var cy=(targetBox.minY+targetBox.maxY)/2;
    var bx=(b.minX+b.maxX)/2, by=(b.minY+b.maxY)/2;
    var out=new Array(pts.length);
    for(var i=0;i<pts.length;i++){
      var p=pts[i];
      out[i]={ x:(p.x-bx)*s + cx, y:(p.y-by)*s + cy };
    }
    return out;
  }
  function nearestAvgDistance(A,B){
    if(!A.length||!B.length) return 1e9;
    var sum=0;
    for(var i=0;i<A.length;i++){
      var a=A[i], best=1e9;
      for(var j=0;j<B.length;j+=3){
        var dx=a.x-B[j].x, dy=a.y-B[j].y;
        var d=dx*dx+dy*dy;
        if(d<best) best=d;
      }
      sum += Math.sqrt(best);
    }
    return sum/A.length;
  }

  // ===== Shapes (normalized 0..1) =====
  function shapeCircle(t){ var a=2*Math.PI*t; return {x:0.5+0.42*Math.cos(a), y:0.5+0.42*Math.sin(a)}; }
  function shapeSquare(t){
    var p=t*4;
    if (p<1) return {x: lerp(0.08,0.92,p), y:0.08};
    if (p<2) return {x:0.92, y: lerp(0.08,0.92,p-1)};
    if (p<3) return {x: lerp(0.92,0.08,p-2), y:0.92};
    return {x:0.08, y: lerp(0.92,0.08,p-3)};
  }
  function shapeTriangle(t){
    var A={x:0.5,y:0.08}, B={x:0.92,y:0.9}, C={x:0.08,y:0.9};
    var perAB=0.34, perBC=0.33, u;
    if (t<perAB){ u=t/perAB; return {x: lerp(A.x,B.x,u), y: lerp(A.y,B.y,u)}; }
    if (t<perAB+perBC){ u=(t-perAB)/perBC; return {x: lerp(B.x,C.x,u), y: lerp(B.y,C.y,u)}; }
    u=(t-perAB-perBC)/(1-perAB-perBC); return {x: lerp(C.x,A.x,u), y: lerp(C.y,A.y,u)};
  }
  function shapeStar(t){
    var R=0.42, r=R*0.4, cx=0.5, cy=0.5;
    var i=Math.floor(t*10), frac=(t*10 - i);
    var a0=(i)*Math.PI/5 - Math.PI/2, a1=(i+1)*Math.PI/5 - Math.PI/2;
    var rad0=(i%2===0? R: r), rad1=((i+1)%2===0? R: r);
    return { x: cx + (rad0*Math.cos(a0) + (rad1*Math.cos(a1)-rad0*Math.cos(a0))*frac),
             y: cy + (rad0*Math.sin(a0) + (rad1*Math.sin(a1)-rad0*Math.sin(a0))*frac) };
  }
  function shapeHeart(t){
    var a=2*Math.PI*t;
    var x=0.5 + 0.36*Math.pow(Math.sin(a),3);
    var y=0.5 - 0.26*( 13*Math.cos(a)-5*Math.cos(2*a)-2*Math.cos(3*a)-Math.cos(4*a) )/13;
    return {x:x,y:y};
  }

  var SHAPES = [
    {name:"Circle", gen:shapeCircle},
    {name:"Square", gen:shapeSquare},
    {name:"Triangle", gen:shapeTriangle},
    {name:"Star", gen:shapeStar},
    {name:"Heart", gen:shapeHeart}
  ];

  // ===== HiDPI sizing =====
  function fitHiDPICanvas(c, ctx) {
    var dpr = window.devicePixelRatio || 1;
    var cssW = Math.max(1, Math.floor(c.clientWidth));
    var cssH = Math.max(1, Math.floor(c.clientHeight));
    c.width  = Math.round(cssW * dpr);
    c.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // 1 unit = 1 CSS pixel
    return { cssW:cssW, cssH:cssH, dpr:dpr };
  }

  function resizeAll() {
    var board = document.querySelector('.board');
    var cssSize = Math.floor(board.clientWidth);
    canvas.style.width = cssSize + 'px';
    canvas.style.height = cssSize + 'px';

    var prevSize = 56;
    prevCanvas.style.width = prevSize + 'px';
    prevCanvas.style.height = prevSize + 'px';

    fitHiDPICanvas(canvas, ctx);
    fitHiDPICanvas(prevCanvas, pctx);

    var PAD = 24;
    boardBox.minX = PAD;
    boardBox.minY = PAD;
    boardBox.maxX = canvas.clientWidth - PAD;
    boardBox.maxY = canvas.clientHeight - PAD;
    boardBox.w = boardBox.maxX - boardBox.minX;
    boardBox.h = boardBox.maxY - boardBox.minY;

    clearCanvas();
    renderTargetPreview();
  }

  window.addEventListener('resize', resizeAll);
  window.addEventListener('orientationchange', resizeAll);

  // ===== Drawing / input =====
  function getPos(e){
    var rect = canvas.getBoundingClientRect();
    var x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    var y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    return { x:x, y:y };
  }

  var rounds = 5, order = [], idx = 0, total = 0;
  var drawing = false, stroke = [];

  function sampleShape(gen, n, box){
    var pts=new Array(n);
    for(var i=0;i<n;i++){
      var t=i/(n-1);
      var p=gen(t);
      pts[i]={ x: lerp(box.minX, box.maxX, p.x), y: lerp(box.minY, box.maxY, p.y) };
    }
    return pts;
  }

  function renderHUD(){
    roundEl.textContent=(idx+1)+" / "+rounds;
    shapeNameEl.textContent = order[idx].name;
  }

  function clearCanvas(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawGuide();
  }

  function drawGuide(){
    ctx.save();
    ctx.lineWidth=1;
    ctx.strokeStyle='#1f2a44';
    ctx.strokeRect(boardBox.minX,boardBox.minY,boardBox.w,boardBox.h);

    var pts = sampleShape(order[idx].gen, 240, boardBox);
    ctx.beginPath();
    for(var i=0;i<pts.length;i++){
      var p=pts[i];
      if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y);
    }
    ctx.closePath();
    ctx.globalAlpha=0.15;
    ctx.strokeStyle='white';
    ctx.stroke();
    ctx.restore();
  }

  function renderTargetPreview(){
    pctx.clearRect(0,0,prevCanvas.width,prevCanvas.height);
    var bb = { minX:4, minY:4, maxX:prevCanvas.width-4, maxY:prevCanvas.height-4 };
    bb.w = bb.maxX - bb.minX; bb.h = bb.maxY - bb.minY;

    var pts = sampleShape(order[idx].gen, 140, bb);
    pctx.beginPath();
    for(var i=0;i<pts.length;i++){
      var p=pts[i];
      if(i===0) pctx.moveTo(p.x,p.y); else pctx.lineTo(p.x,p.y);
    }
    pctx.closePath();
    pctx.lineWidth=2;
    pctx.strokeStyle='#22d3ee';
    pctx.stroke();
  }

  function startDraw(e){
    if(e) e.preventDefault();
    drawing=true; stroke=[];
    var p=getPos(e); stroke.push(p);
  }
  function moveDraw(e){
    if(!drawing) return;
    var p=getPos(e); stroke.push(p);
    var a=stroke[stroke.length-2], b=stroke[stroke.length-1];
    ctx.strokeStyle='#e2e8f0';
    ctx.lineWidth=3;
    ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
  }
  function endDraw(){
    if(!drawing) return;
    drawing=false;
    submitStroke();
  }

  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', moveDraw);
  window.addEventListener('mouseup', endDraw);
  canvas.addEventListener('touchstart', startDraw, {passive:false});
  canvas.addEventListener('touchmove', moveDraw, {passive:false});
  canvas.addEventListener('touchend', endDraw);

  // ===== Scoring =====
  function scoreAgainst(targetPts, userPtsRaw){
    if (userPtsRaw.length<8) return 0;

    var userRes = resample(userPtsRaw.slice(), 220);
    var user = normalizeToBox(userRes, boardBox, 6);

    var avgD = nearestAvgDistance(targetPts, user);
    var tol = Math.min(boardBox.w, boardBox.h) * 0.02; // 2% of board
    var coverage = Math.exp(-avgD / tol);

    var tLen = polylineLength(targetPts);
    var uLen = polylineLength(user);
    var lenErr = Math.abs(uLen - tLen) / (tLen||1);
    var lenFactor = Math.exp(-1.2*lenErr);

    var closeGap = dist(user[0], user[user.length-1]) / (tLen||1);
    var closeFactor = Math.exp(-6*closeGap);

    var raw = 100 * (0.65*coverage + 0.20*lenFactor + 0.15*closeFactor);
    var s = Math.round(clamp(raw, 0, 100));
    return s;
  }

  function submitStroke(){
    var target = sampleShape(order[idx].gen, 240, boardBox);
    var s = scoreAgainst(target, stroke);
    total += s;
    lastScoreEl.textContent = String(s);
    totalScoreEl.textContent = String(total);
    var c = (s>=85? '#22c55e' : (s>=60? '#f59e0b' : '#ef4444'));
    toast.innerHTML = 'Shape scored <b style="color:'+c+'">'+s+'</b>/100';

    idx++;
    if (idx>=rounds){ finishGame(); }
    else { renderHUD(); clearCanvas(); renderTargetPreview(); }
  }

  function finishGame(){
    finalBox.style.display='block';
    restartBtn.style.display='block';
    finalScore.textContent = 'Total: ' + total;
    var rank = (total>=430)? 'Circle Master 🎯' :
               (total>=360)? 'Egg Drawer 🥚' :
               (total>=280)? 'Potato Artist 🥔' :
               (total>=200)? 'Oval Enjoyer 🥚➡️⭕' : 'Worm Doodler 🪱';
    finalRank.textContent = 'Rank: ' + rank;
    toast.textContent = 'Game over! Nice doodles.';
  }

  // ===== Game flow =====
  function pickOrder(){
    var pool = SHAPES.concat(SHAPES); // allow repeats, more randomness
    order = [];
    for(var i=0;i<rounds;i++){
      order.push( pool[Math.floor(Math.random()*pool.length)] );
    }
    idx=0; total=0;
    lastScoreEl.textContent='–';
    totalScoreEl.textContent='0';
    finalBox.style.display='none';
    restartBtn.style.display='none';
    clearCanvas();
    renderHUD();
    renderTargetPreview();
    drawGuide();
  }

  clearBtn.onclick = function(){ stroke=[]; clearCanvas(); toast.textContent='Cleared. Draw again.'; };
  skipBtn.onclick = function(){
    lastScoreEl.textContent='0';
    idx++;
    if (idx>=rounds) finishGame();
    else { renderHUD(); clearCanvas(); renderTargetPreview(); toast.textContent='Skipped. Next shape.'; }
  };
  restartBtn.onclick = function(){ pickOrder(); toast.textContent='New game. Draw the shape shown!'; };

  // ===== Boot after DOM ready =====
  function boot(){
    resizeAll();   // ensures canvas size + DPR scale
    pickOrder();
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();
</script>
</body>
</html>
